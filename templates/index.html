<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Log Viewer with Multi-Filter</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <!-- 左側：上傳與顯示原始 log -->
    <div class="left">
      <h2 id="drop_zone">Drag & Drop Log File</h2>
      <!-- 新增：手動上傳區塊 -->
      <div style="margin-top: 10px;">
        <input type="file" id="file_input" accept=".log,.txt">
        <button id="upload_btn">Upload Log</button>
      </div>
      <h2>Filter List</h2>
      <div class="filter-input">
        <input type="text" id="filter_input" placeholder="Enter regex keyword（Ex: error|fail）">
        <button id="add_filter_btn">ADD Filter</button>
      </div>
      <div style="margin: 10px 0;">
        <label>
          <input type="checkbox" id="case_sensitive_toggle">
          Case Sensitive
        </label>
      </div>
      <ul id="filter_list">
        <!-- 動態產生的 filter 列表，每筆 filter 可點選刪除 -->
      </ul>
      
    </div>

    <!-- 右側：管理多個 filter 與呈現結果 -->
    <div class="right">
      <h2>Results</h2>
      <ol id="filtered_content" class="line-numbered">No data</ol>
    </div>
  </div>

  <script>
    let rawText = "";
    let filters = [
      { text: 'error', enabled: true },
      { text: 'fail', enabled: true }
    ];

    // 取得 DOM 元素
    const dropZone = document.getElementById('drop_zone');
    const rawContent = document.getElementById('raw_content');
    const filteredContent = document.getElementById('filtered_content');
    const filterInput = document.getElementById('filter_input');
    const addFilterBtn = document.getElementById('add_filter_btn');
    const filterList = document.getElementById('filter_list');
    const fileInput = document.getElementById('file_input');
    const uploadBtn = document.getElementById('upload_btn');

    // 拖曳上傳事件
    dropZone.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.style.borderColor = '#555';
    });

    dropZone.addEventListener('dragleave', function(e) {
      e.preventDefault();
      this.style.borderColor = '#aaa';
    });

    dropZone.addEventListener('drop', function(e) {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      const formData = new FormData();
      formData.append('file', file);

      fetch('upload', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          rawText = data.content;
          //updateRawContent(rawText);
          // 當有新的檔案時，重設 filter 與 filter 列表
          //filters = [];
          updateFilterList();
          updateFilteredContent();
        } else {
          alert(data.message);
        }
      });
      updateFilterList();
      updateFilteredContent(); // 更新顯示結果
    });
    
    // 處理 Upload 按鈕點擊事件
    uploadBtn.addEventListener('click', function () {
      const file = fileInput.files[0];
      if (!file) {
        alert("Please select a log file to upload.");
        return;
      }

      const formData = new FormData();
      formData.append('file', file);

      fetch('upload', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          rawText = data.content;
          //filters = [];
          updateFilterList();
          updateFilteredContent();
        } else {
          alert(data.message);
        }
      });
    });

    // 新增 filter 按鈕點擊事件
    addFilterBtn.addEventListener('click', function() {
      const keyword = filterInput.value.trim();
      if (keyword && !filters.some(f => f.text === keyword)) {
        filters.push({ text: keyword, enabled: true }); // 新增物件
        filterInput.value = "";
        updateFilterList();
        updateFilteredContent();
      }
    });

    // 更新 filter 列表的顯示
    function updateFilterList() {
      filterList.innerHTML = "";
      filters.forEach((filterObj, index) => {
        const li = document.createElement('li');

        // checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = filterObj.enabled;
        checkbox.addEventListener('change', function() {
          filters[index].enabled = this.checked;
          saveFiltersToLocalStorage(); // ← 加入儲存
          updateFilteredContent();
        });

        // label
        const span = document.createElement('span');
        span.textContent = " " + filterObj.text + " ";

        // delete button
        const delBtn = document.createElement('button');
        delBtn.textContent = "DEL";
        delBtn.addEventListener('click', function() {
          filters.splice(index, 1);
          updateFilterList();
          updateFilteredContent();
        });

        li.appendChild(checkbox);
        li.appendChild(span);
        li.appendChild(delBtn);
        filterList.appendChild(li);
      });

      saveFiltersToLocalStorage();  // ← 在列表更新完後儲存

    }

    // 更新篩選結果（帶行號）
    function updateFilteredContent() {
      const caseSensitive = document.getElementById('case_sensitive_toggle').checked;

      // 只傳送啟用的條件文字
      const activeFilters = filters.filter(f => f.enabled).map(f => f.text);

      fetch('filter', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          content: rawText,
          filters: activeFilters,
          case_sensitive: caseSensitive
        })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) {
          filteredContent.innerHTML = `[Error] ${data.message}`;
          return;
        }

        filteredContent.innerHTML = "";
        data.filtered.forEach(entry => {
          const li = document.createElement('li');
          li.textContent = `[${entry.line_number}] ${entry.text}`;
          filteredContent.appendChild(li);
        });
      });
    }

    // 更新原始 log 顯示（帶行號）
    function updateRawContent(text) {
      rawContent.innerHTML = "";
      text.split("\n").forEach(line => {
        const li = document.createElement('li');
        li.textContent = line;
        rawContent.appendChild(li);
      });
    }

    function saveFiltersToLocalStorage() {
      localStorage.setItem('savedFilters', JSON.stringify(filters));
    }

    function loadFiltersFromLocalStorage() {
      const saved = localStorage.getItem('savedFilters');
      if (saved) {
        try {
          filters = JSON.parse(saved);
        } catch (e) {
          filters = [];
        }
      }
    }

    // 勾選/取消 "Case Sensitive" 時，自動更新篩選結果
    document.getElementById('case_sensitive_toggle').addEventListener('change', function() {
      updateFilteredContent();
    });

    // 初始時載入 localStorage 的 filters
    loadFiltersFromLocalStorage();
    updateFilterList();
    updateFilteredContent();
    
  </script>
</body>
</html>
